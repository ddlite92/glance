{{ define "widget-content" }}
<div class="afanasy-jobs-table-container">
  <input type="text" id="jobSearch" placeholder="Search by user/job name..." onkeyup="filterJobsTable()" />
  <button onclick="exportJobsTable()">Export CSV</button>
  <table id="afanasyJobsTable" class="ag-theme-balham">
    <thead>
      <tr>
        <th onclick="sortJobsTable(0)">User Name</th>
        <th onclick="sortJobsTable(1)">Job Name</th>
        <th>Branch</th>
        <th>Priority</th>
        <th>Status</th>
        <th>Progress (%)</th>
        <th>Frames</th>
        <th>ETA</th>
      </tr>
    </thead>
    <tbody>
      {{range .Jobs}}
      <tr class="{{if eq .State "ERR"}}job-error{{else if eq .State "DON"}}job-finished{{else}}job-running{{end}}">
        <td>{{.UserName}}</td>
        <td>{{.Name}}</td>
        <td>{{.Branch}}</td>
        <td>{{.Priority}}</td>
        <td>
          <span class="{{if eq .State "DON"}}status-finished{{else if eq .State "ERR"}}status-error{{else}}status-running{{end}}">
            {{if eq .State "DON"}}Finished{{else if eq .State "ERR"}}Error{{else}}Running{{end}}
          </span>
        </td>
        <td>{{printf "%.2f" .Percentage}}</td>
        <td>{{if .Blocks}}{{len .Blocks}}{{else}}-{{end}}</td>
        <td>-</td>
      </tr>
      {{end}}
    </tbody>
  </table>
</div>
<script>
function naturalSort(a, b) {
  return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
}
function sortJobsTable(colIdx) {
  var table = document.getElementById('afanasyJobsTable');
  var rows = Array.from(table.tBodies[0].rows);
  var asc = table.getAttribute('data-sort-asc') === 'true';
  rows.sort(function(a, b) {
    return asc ? naturalSort(a.cells[colIdx].innerText, b.cells[colIdx].innerText)
               : naturalSort(b.cells[colIdx].innerText, a.cells[colIdx].innerText);
  });
  rows.forEach(row => table.tBodies[0].appendChild(row));
  table.setAttribute('data-sort-asc', !asc);
}
function filterJobsTable() {
  var input = document.getElementById('jobSearch').value.toLowerCase();
  var table = document.getElementById('afanasyJobsTable');
  Array.from(table.tBodies[0].rows).forEach(row => {
    row.style.display = row.cells[0].innerText.toLowerCase().includes(input) || row.cells[1].innerText.toLowerCase().includes(input) ? '' : 'none';
  });
}
function exportJobsTable() {
  var table = document.getElementById('afanasyJobsTable');
  var csv = [];
  for (var i = 0, row; row = table.rows[i]; i++) {
    var cols = Array.from(row.cells).map(cell => '"' + cell.innerText.replace(/"/g, '""') + '"');
    csv.push(cols.join(','));
  }
  var csvStr = csv.join('\n');
  var blob = new Blob([csvStr], { type: 'text/csv' });
  var link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'afanasy-jobs.csv';
  link.click();
}
setTimeout(() => location.reload(), 30000);
</script>
<style>
.afanasy-jobs-table-container { max-width: 100%; overflow-x: auto; }
#afanasyJobsTable { width: 100%; border-collapse: collapse; }
#afanasyJobsTable th, #afanasyJobsTable td { border: 1px solid #ccc; padding: 6px 10px; }
#afanasyJobsTable th { background: #f5f5f5; cursor: pointer; }
#jobSearch { margin-bottom: 8px; padding: 4px 8px; }
tr.job-error { background: #ffeaea; color: #b30000; }
tr:hover { background: #f0f8ff; }
</style>
